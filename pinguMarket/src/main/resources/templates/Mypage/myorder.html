<!DOCTYPE html>
<div layout:decorate="~{Layout/layout}">
    <!-- *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-* MAIN *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*--*-*-*-*-*-*-*-*-*-* -->
    <main layout:fragment="content">
    <link rel="stylesheet" href="/substatic/MyPage/myPageStyle.css">
    	<style>
  
.contentListContainer {
		    display: flex;
		    align-items: center;
		    border: 1px solid #ccc;
		    border-radius: 10px;
		    margin: 0.5rem 0;
		    overflow: hidden;
		    cursor: pointer;
		}
		.contentHeader {
		    display: grid;
		    margin-top: 1rem;
		    padding-left:10px;
		    grid-template-columns: 1fr 1fr 1.7fr 1fr 1fr 1fr;
		    font-weight: bold;
		    padding: 0.5rem;
		    border-bottom: 2px solid;
		    text-align: center;
		    background-color: rgb(238, 238, 238);
		}
		
		.productImage {
		    width: 75px;
		    height: 75px;
		    flex-shrink: 0;
		}
		
		.productImage img {
		    width: 100%;
		    height: 100%;
		    object-fit: cover;
		}
		
		.contentListInfo {
		    display: grid;
		    grid-template-columns: 1fr 1fr 1.7fr 1fr 1fr 1fr;
		    align-items: center;
		    text-align: center;
		    width: 100%;
		    padding: 0.5rem;
		    gap: 0.5rem;
		}
    </style>
        <div class="myPageContainer">

            <div class="myPageLeft">
                <div class="myInfo">
                    <p class="myName"><span th:text="${user.name}"></span>님</p>
                    <div class="myCard">
                        <div class="cardSaving">
                            <p>적립금</p>
                            <p><span class="cardMoney">0</span>원</p>
                        </div>
                        <div class="cardCash">
                            <p>캐쉬</p>
                            <p><span class="cardMoney">0</span>원</p>
                        </div>
                        <div class="cardMemberShip">
                            <p>멤버스 무료체험</p>
                        </div>
                    </div>
                </div>

                <div class="navContainer">
                    <ul>
                        <p>자주찾는 메뉴</p>
                        <li><a th:href="@{/myorder}">주문내역</a></li>
                        <li><a th:href="@{/mycoupon}">쿠폰</a></li>
                        <li><a href="#">찜한상품</a></li>
                        <li><a href="#">자주구매</a></li>
                    </ul>
                    <ul>
                        <p>쇼핑</p>
                        <li><a href="#">결제수단 or 00페이</a></li>
                        <li><a th:href="@{/myreview}">상품후기</a></li>
                        <li><a href="#">선물 내역</a></li>
                        <li><a href="#">상품 문의</a></li>
                    </ul>
                    <ul>
                        <p>혜택</p>
                        <li><a href="#">회사멤버스</a></li>
                    </ul>
                    <ul>
                        <p>내정보관리</p>
                        <li><a th:href="@{/usermodify}">개인정보 수정</a></li>
                        <li><a th:href="@{/usermodify/pw}">비밀번호 수정</a></li>
                        <li><a th:href="@{/signout}">회원 탈퇴</a></li>
                    </ul>
                    <ul>
                        <p>서비스안내</p>
                        <li><a href="#">퍼플박스</a></li>
                        <li><a href="#">VIP제도 안내</a></li>
                    </ul>
                </div>
            </div>


            <div class="myPageRight">
                <div class="myPageTitle">
                    <p>주문내역</p>
                    <ul>
                        <li><a href="#" id="period" value="3">3개월</a></li>
                        <li><a href="#" id="period" value="6">6개월</a></li>
                        <li><a href="#" id="period" value="12">1년</a></li>
                        <li><a href="#" id="period" value="36">3년</a></li>
                    </ul>
                    
                     <div class="contentHeader">
                        <span></span>
                        <span>결제일</span>
                        <span>결제액</span>
                        <span>대표 상품명</span>
                        <span>주문 번호</span>
                        <span>배송 상태</span>
                     </div>

    <!-- 결제 내역이 없을 때 표시 -->
    <div th:if="${paymentList.isEmpty()}">
        구매내역이 없습니다.
    </div>

    <!-- 각 결제 내역 반복 -->
    <div class="contentListContainer" 
         th:each="payment, iterStat : ${paymentList}"
         th:onclick="|location.href='@{/myorder/detail/{paymentId}(paymentId=${payment.paymentId})}'|">
         

        <!-- 결제 정보 -->
        <div class="contentListInfo">
            <div class="productImage"><img src="/substatic/img/ordertest.jpg" alt="상품 이미지"></div>
            <div class="paymentDate"><span th:text="${#temporals.format(payment.createDate, 'yyyy-MM-dd')}"></span></div>
            <div class="paymentPrice"><span th:text="${totalprice[iterStat.index] + '원'}"></span></div>
            <div class="paymentProductName"><span th:text="${productNames[iterStat.index]}"></span></div>
            <div class="paymentDeliveryno"><span th:text="${payment.deliveryno}"></span></div>
            <div class="paymentDeliveryState"><span th:text="${payment.deliveryState}"></span></div>
        </div>
                   </div> <!-- paymentListContainer 끝 -->
                </div>
                
            
            </div>
        </div>
    </main>
 </div>


 <script>
    const periods = document.querySelectorAll('#period');

    function periodColor(event) {
  // 모든 "on" 클래스 제거
  periods.forEach((e) => {
    e.classList.remove("on");
  });
  // 요소만 "click"클래스 추가
  event.target.classList.add("on");
}

   function periodParameter(e){
	     e.preventDefault();

         const period = e.target.getAttribute("value");
			
			
			fetch('http://localhost:8080/periodloading', {
				method : 'POST',
				headers : {
					'Content-Type': 'application/x-www-form-urlencoded',
				},
				body: new URLSearchParams({period:period})
			})
			.then(response => {
				if(response.ok){
				alert("파라미터 전송이 성공했습니다.");
				//return response.json(); // 여기가 문제인데 괄호가 없을 때는 여기서 오류가 나진 않지만
// console.log(data) 했을 때 ƒ json() { [native code] }라는 게 나오고 forEach에 사용될 속성을 찾을 수 없다는 걸 보면
// 괄호가 없을 때는 아예 넘어오는 게 없고 있을 때는 넘어오려다가
// Expected ':' after property name in JSON at position 225741 (line 1 column 225742) 에러가 뜨는 것 같음
// 그리고 이 에러는 검색해보니 json 형식 문자열이 아니기 때문에 발생한다고 하는데
// 그럼 text로 하면 어떨까? 싶어서 text로 바꾸고 console.log를 해보니
// 왜인지는 알 수 없지만 조회한 적도 없고 dto에 집어넣은 적도 없는 user 테이블 user_id = 1 조회 결과만
// 무한반복해서 나오는 중??? getPayment는 payment 테이블을 조회하는 메서드고
// 다른 것들도 그 getPayment를 바탕으로 특정 값들을 가져오는 메서드일 뿐인데
// 왜 뜬금없이 user 테이블 정보가 나오는지 이해할 수 없는데.. user엔티티 paymentList때문에 무한반복되나?
				}else{
				throw new Error('서버 응답이 실패했습니다.');
				}
			})
			 .then(data => {
              // 서버에서 받은 데이터를 처리
              console.log(data);
             updateOrderList(data);
            })
			
			.catch(error =>{
				alert("오류가 발생하였습니다 " + error.message);
				console.error('Error :', error);
			})
			
		};
		
		function updateOrderList(data) {
    // 여기서 받은 데이터를 사용하여 페이지 업데이트

    // 기존 항목 제거
    const contentListContainers = document.querySelectorAll('.contentListContainer');
    contentListContainers.forEach(e => e.remove());
    data.paymentList.forEach((payment, index) => {
        const orderItem = document.createElement('div');
        orderItem.classList.add('order-item');
        orderItem.innerHTML = `
            <p>주문 날짜: ${payment.orderDate}</p>
            <p>상품명: ${data.productNames[index]}</p>
            <p>총 가격: ${data.totalPrices[index]}원</p>
        `;
        orderListContainer.appendChild(orderItem);
    });
}
   
   

periods.forEach((e) => {
  e.addEventListener("click", periodColor);
  e.addEventListener('click', periodParameter);
});


 </script>